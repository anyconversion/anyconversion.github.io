<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Sign up for RealVibin to connect with like-minded people for fun chats, casual dating, or more.">
  <title>RealVibin - Signup</title>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#0080ff',
            secondary: '#ff4d4f',
            dark: '#1f2937'
          }
        }
      }
    }
  </script>
  <!-- React and ReactDOM Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.development.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.development.js" crossorigin="anonymous"></script>
  <!-- Babel for JSX Transpilation -->
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.20.15/babel.min.js" crossorigin="anonymous"></script>
  <!-- Firebase Modular SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, updatePassword, setPersistence, browserSessionPersistence } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import { getFirestore, collection, addDoc, onSnapshot, orderBy, query, serverTimestamp, getDoc, doc, setDoc } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyCZavBCNmUx2lX4SqdXlYdloCdwmw-hYT8",
      authDomain: "realvibin-9aac1.firebaseapp.com",
      projectId: "realvibin-9aac1",
      messagingSenderId: "155907884818",
      appId: "1:155907884818:web:d499ac21bc81c3273d55cb"
    };

    try {
      console.log('Initializing Firebase...');
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      await setPersistence(auth, browserSessionPersistence);
      const db = getFirestore(app);
      console.log('Firebase initialized successfully');

      window.firebase = {
        app,
        auth,
        db,
        signInWithEmailAndPassword,
        createUserWithEmailAndPassword,
        signOut,
        collection,
        addDoc,
        onSnapshot,
        orderBy,
        query,
        serverTimestamp,
        onAuthStateChanged,
        getDoc,
        doc,
        setDoc,
        updatePassword,
        setPersistence,
        browserSessionPersistence
      };
      window.firebaseInitialized = true;
    } catch (error) {
      console.error('Firebase Initialization Error:', { message: error.message, code: error.code, stack: error.stack });
      window.firebaseError = error;
      window.firebaseInitialized = false;
    }
  </script>
  <link rel="stylesheet" href="./style.css">
  <style>
    body { font-family: 'Open Sans', Arial, sans-serif; background-color: #f3f4f6; }
    .hidden { display: none; }
    .error { padding: 1.5rem; background-color: #fef2f2; color: #991b1b; border: 1px solid #f87171; border-radius: 8px; max-width: 500px; margin: 2rem auto; }
    .error h2 { font-size: 1.5rem; font-weight: bold; }
    .signup-form-grid { display: grid; grid-template-columns: 1fr; gap: 1.5rem; }
    @media (min-width: 768px) { .signup-form-grid { grid-template-columns: repeat(2, 1fr); } }
    .password-match { border-color: #10b981; }
    .password-mismatch { border-color: #ef4444; }
    .section-divider { border-bottom: 2px solid #e5e7eb; margin-bottom: 1.5rem; padding-bottom: 0.5rem; }
    .image-section { display: flex; flex-wrap: wrap; gap: 1rem; }
    .main-profile-pic { width: 300px; height: 300px; object-fit: cover; border-radius: 8px; }
    .standard-pic-container { flex: 1; max-height: 320px; overflow-y: auto; padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 8px; }
    .private-pic-container { flex: 1; max-height: 320px; overflow-y: auto; padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 8px; }
    .pic-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; }
    .standard-pic, .private-pic { width: 100px; height: 100px; object-fit: cover; border-radius: 4px; }
    .image-actions { margin-top: 0.5rem; display: flex; gap: 0.5rem; }
    .uploading { opacity: 0.5; pointer-events: none; }
    .form-input { width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; }
    .form-label { display: block; font-weight: 600; margin-bottom: 0.25rem; }
    .container { max-width: 1200px; margin: 0 auto; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    // Check for critical dependencies
    if (!window.React || !window.ReactDOM || !window.Babel) {
      console.error('Required libraries (React, ReactDOM, or Babel) not loaded.');
      document.getElementById('root').innerHTML = '<div class="error"><h2>Error</h2><p>Failed to load essential libraries. Please check your internet connection and try again.</p></div>';
      throw new Error('React, ReactDOM, or Babel is not available');
    }

    const fetchUserProfile = async (userId) => {
      console.log('fetchUserProfile called:', { userId });
      try {
        const cached = sessionStorage.getItem(`userProfile_${userId}`);
        if (cached) {
          const profile = JSON.parse(cached);
          console.log(`Using cached profile for ${userId}:`, profile);
          return profile;
        }
        const userDoc = await window.firebase.getDoc(window.firebase.doc(window.firebase.db, 'users', userId));
        if (!userDoc.exists()) {
          console.warn(`No user profile for UID: ${userId}, using defaults`);
          return {
            username: 'Unknown User',
            profilePicture: 'https://placehold.co/40x40?text=User',
            uid: userId
          };
        }
        const data = userDoc.data();
        const profilePicture = data.basicInfo?.profilePicture || data.profileImage || 'https://placehold.co/40x40?text=User';
        const profile = {
          username: data.basicInfo?.username || data.username || 'Unknown User',
          profilePicture,
          uid: userId
        };
        console.log(`Fetched profile for ${userId}:`, profile);
        sessionStorage.setItem(`userProfile_${userId}`, JSON.stringify(profile));
        return profile;
      } catch (error) {
        console.error('fetchUserProfile error:', error.message, error.stack);
        return {
          username: 'Unknown User',
          profilePicture: 'https://placehold.co/40x40?text=User',
          uid: userId
        };
      }
    };

    function Header({ user, setUser }) {
      const [isMenuOpen, setIsMenuOpen] = React.useState(false);
      const [email, setEmail] = React.useState('');
      const [password, setPassword] = React.useState('');
      const [loginError, setLoginError] = React.useState(null);
      const [displayName, setDisplayName] = React.useState('User');
      const [unreadCount, setUnreadCount] = React.useState(0);
      const firebase = window.firebase;

      React.useEffect(() => {
        console.log('Header: user prop:', user);
        const loadUserProfile = async () => {
          if (user?.uid) {
            const profile = await fetchUserProfile(user.uid);
            setDisplayName(profile.username || 'User');
            console.log('Header: Fetched profile for displayName:', { uid: user.uid, username: profile.username });
            if (!user.profile?.username) {
              setUser(prev => ({ ...prev, profile }));
            }
          } else {
            setDisplayName('User');
          }
        };
        loadUserProfile();
      }, [user?.uid]);

      React.useEffect(() => {
        if (!user?.uid || !firebase.db) return;
        const unsubscribe = firebase.onSnapshot(
          firebase.collection(firebase.db, `users/${user.uid}/unreadConversations`),
          (snapshot) => {
            let totalUnread = 0;
            snapshot.forEach(doc => {
              totalUnread += doc.data().unreadCount || 0;
            });
            setUnreadCount(totalUnread);
            console.log('Unread count updated:', totalUnread);
          },
          (error) => {
            console.error('Unread count snapshot error:', error);
          }
        );
        return () => unsubscribe();
      }, [user?.uid]);

      const debounce = (fn, delay) => {
        let timeout;
        return (...args) => {
          clearTimeout(timeout);
          timeout = setTimeout(() => fn(...args), delay);
        };
      };

      const handleLogin = async (e) => {
        e.preventDefault();
        if (!firebase?.auth) {
          setLoginError('Authentication service not available.');
          return;
        }
        try {
          setLoginError(null);
          const userCredential = await firebase.signInWithEmailAndPassword(firebase.auth, email, password);
          const user = userCredential.user;
          const profile = await fetchUserProfile(user.uid);
          await firebase.setDoc(
            firebase.doc(firebase.db, 'users', user.uid),
            { loginStatus: 'logged_in', lastLogin: firebase.serverTimestamp() },
            { merge: true }
          );
          setEmail('');
          setPassword('');
          setUser({
            ...user,
            profile,
            loginStatus: 'logged_in'
          });
          setDisplayName(profile.username || 'User');
          console.log('Login successful, user data:', { uid: user.uid, username: profile.username });
        } catch (error) {
          console.error('Login error:', error);
          setLoginError(`Login error: ${error.message || 'An unexpected error occurred'}`);
        }
      };

      const handleLogout = debounce(async () => {
        if (!firebase?.auth) {
          setLoginError('Authentication service not available.');
          return;
        }
        try {
          if (user) {
            await firebase.setDoc(
              firebase.doc(firebase.db, 'users', user.uid),
              { loginStatus: 'logged_out', lastLogout: firebase.serverTimestamp() },
              { merge: true }
            );
            sessionStorage.removeItem(`userProfile_${user.uid}`);
          }
          await firebase.signOut(firebase.auth);
          setUser(null);
          setDisplayName('User');
          setIsMenuOpen(false);
          console.log('Logout successful');
        } catch (error) {
          console.error('Logout error:', error);
          setLoginError(`Logout error: ${error.message || 'An unexpected error occurred'}`);
        }
      }, 300);

      return (
        <nav className="bg-primary shadow-md sticky top-0 z-50">
          <div className="container flex items-center justify-between h-auto min-h-[64px] px-2 sm:px-4 py-2">
            <div className="logo-container flex items-center">
              <a href="/">
                <img
                  src="./img/RealVibin.png"
                  alt="RealVibin Logo"
                  className="h-12 sm:h-16 md:h-[100px] w-auto"
                />
              </a>
            </div>
            <div className="auth-container hidden md:flex items-center space-x-4">
              {loginError && (
                <div className="text-red-200 text-sm">{loginError}</div>
              )}
              {user && user.loginStatus === 'logged_in' ? (
                <div className="flex items-center space-x-2">
                  <a
                    href={`profile.html?uid=${user.uid}`}
                    className="text-white font-semibold hover:underline"
                  >
                    {displayName}
                  </a>
                  <a
                    href="messages.html"
                    className="relative text-white hover:text-white"
                  >
                    <svg
                      className="h-6 w-6"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        strokeLinecap="round"
                        strokeLinejoin="round"
                        strokeWidth="2"
                        d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"
                      />
                    </svg>
                    {unreadCount > 0 && (
                      <span className="absolute -top-1 -right-1 bg-primary text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">
                        {unreadCount}
                      </span>
                    )}
                  </a>
                  <a
                    href="/"
                    className="bg-primary text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition"
                  >
                    Home
                  </a>
                  <a
                    href="users.html"
                    className="bg-primary text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition"
                  >
                    Browse
                  </a>
                  <button
                    type="button"
                    className="bg-primary text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition"
                    onClick={handleLogout}
                  >
                    Logout
                  </button>
                </div>
              ) : (
                <div className="flex items-center space-x-2">
                  <div className="flex flex-col space-y-2 w-full md:flex-row md:space-y-0 md:space-x-2">
                    <input
                      type="email"
                      placeholder="Email"
                      value={email}
                      onChange={(e) => setEmail(e.target.value)}
                      className="form-input"
                      required
                      autoComplete="email"
                    />
                    <input
                      type="password"
                      placeholder="Password"
                      value={password}
                      onChange={(e) => setPassword(e.target.value)}
                      className="form-input"
                      required
                      autoComplete="current-password"
                    />
                    <button
                      onClick={handleLogin}
                      className="bg-primary text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition"
                    >
                      Login
                    </button>
                  </div>
                  <a
                    href="signup.html"
                    className="bg-primary text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition text-sm"
                  >
                    Need an account?
                  </a>
                </div>
              )}
            </div>
            <div className="md:hidden flex items-center">
              <button
                onClick={() => setIsMenuOpen(!isMenuOpen)}
                className="text-white hover:text-white focus:outline-none"
                type="button"
              >
                <svg
                  className="h-6 w-6"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    strokeWidth="2"
                    d={isMenuOpen ? 'M6 18L18 6M6 6l12 12' : 'M4 6h16M4 12h16M4 18h16'}
                  />
                </svg>
              </button>
            </div>
          </div>
          {isMenuOpen && (
            <div className="md:hidden bg-primary shadow-md px-2 py-4">
              {loginError && (
                <div className="text-red-200 text-sm mb-2">{loginError}</div>
              )}
              {user && user.loginStatus === 'logged_in' ? (
                <div className="flex flex-col space-y-2">
                  <a
                    href={`profile.html?uid=${user.uid}`}
                    className="text-white font-semibold hover:underline text-center"
                  >
                    {displayName}
                  </a>
                  <a
                    href="messages.html"
                    className="text-white font-semibold py-2 hover:bg-blue-700 text-center relative"
                  >
                    Messages
                    {unreadCount > 0 && (
                      <span className="absolute top-1 right-2 bg-primary text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">
                        {unreadCount}
                      </span>
                    )}
                  </a>
                  <a
                    href="/"
                    className="bg-primary text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition text-center"
                  >
                    Home
                  </a>
                  <a
                    href="users.html"
                    className="bg-primary text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition text-center"
                  >
                    Browse
                  </a>
                  <button
                    type="button"
                    className="bg-primary text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition"
                    onClick={handleLogout}
                  >
                    Logout
                  </button>
                </div>
              ) : (
                <div className="flex flex-col space-y-2">
                  <div className="flex flex-col space-y-2">
                    <input
                      type="email"
                      placeholder="Email"
                      value={email}
                      onChange={(e) => setEmail(e.target.value)}
                      className="form-input"
                      required
                      autoComplete="email"
                    />
                    <input
                      type="password"
                      placeholder="Password"
                      value={password}
                      onChange={(e) => setPassword(e.target.value)}
                      className="form-input"
                      required
                      autoComplete="current-password"
                    />
                    <button
                      onClick={handleLogin}
                      className="bg-primary text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition"
                    >
                      Login
                    </button>
                  </div>
                  <a
                    href="signup.html"
                    className="bg-primary text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition text-center text-sm"
                  >
                    Need an account?
                  </a>
                </div>
              )}
            </div>
          )}
        </nav>
      );
    }

    function Footer() {
      return (
        <footer className="bg-dark text-white py-8 mt-auto">
          <div className="container text-center px-2 sm:px-4">
            <p>© 2025 RealVibin. All rights reserved.</p>
            <div className="mt-4 flex justify-center space-x-4">
              <a href="#" className="text-gray-400 hover:text-white">Privacy Policy</a>
              <a href="#" className="text-gray-400 hover:text-white">Terms of Service</a>
              <a href="#" className="text-gray-400 hover:text-white">Contact</a>
            </div>
          </div>
        </footer>
      );
    }

    function ErrorBoundary({ children }) {
      const [error, setError] = React.useState(null);
      const [errorInfo, setErrorInfo] = React.useState(null);

      React.useEffect(() => {
        const handleError = (event) => {
          if (event.error) {
            setError(event.error);
            setErrorInfo({ componentStack: event.error.stack });
            console.error('ErrorBoundary caught:', event.error.message, event.error.stack);
          }
        };
        window.addEventListener('error', handleError);
        return () => window.removeEventListener('error', handleError);
      }, []);

      if (error) {
        return (
          <div className="error">
            <h2>Something went wrong</h2>
            <p>{error.message}</p>
            <details className="mt-4">
              <summary className="cursor-pointer">Stack trace</summary>
              <pre className="text-sm">{errorInfo?.componentStack}</pre>
            </details>
          </div>
        );
      }
      return children;
    }

    const CLOUDINARY_CLOUD_NAME = 'ddmrplnut';
    const CLOUDINARY_UPLOAD_PRESET = 'realvibin_unsigned';

    function SignupForm() {
      const [firstName, setFirstName] = React.useState('');
      const [lastName, setLastName] = React.useState('');
      const [username, setUsername] = React.useState('');
      const [email, setEmail] = React.useState('');
      const [password, setPassword] = React.useState('');
      const [confirmPassword, setConfirmPassword] = React.useState('');
      const [rawPhoneNumber, setRawPhoneNumber] = React.useState('');
      const [phoneNumber, setPhoneNumber] = React.useState('');
      const [dateOfBirth, setDateOfBirth] = React.useState('');
      const [genderIdentity, setGenderIdentity] = React.useState('');
      const [sexualOrientation, setSexualOrientation] = React.useState('');
      const [relationshipStatus, setRelationshipStatus] = React.useState('');
      const [interestedIn, setInterestedIn] = React.useState('');
      const [height, setHeight] = React.useState('');
      const [bodyType, setBodyType] = React.useState('');
      const [hairColor, setHairColor] = React.useState('');
      const [eyeColor, setEyeColor] = React.useState('');
      const [ethnicity, setEthnicity] = React.useState('');
      const [distinguishingFeatures, setDistinguishingFeatures] = React.useState('');
      const [drinkingHabits, setDrinkingHabits] = React.useState('');
      const [smokingHabits, setSmokingHabits] = React.useState('');
      const [fourTwentyFriendly, setFourTwentyFriendly] = React.useState('');
      const [otherSubstanceUse, setOtherSubstanceUse] = React.useState('');
      const [occupation, setOccupation] = React.useState('');
      const [languagesSpoken, setLanguagesSpoken] = React.useState('');
      const [pets, setPets] = React.useState('');
      const [children, setChildren] = React.useState('');
      const [currentCity, setCurrentCity] = React.useState('');
      const [zipCode, setZipCode] = React.useState('');
      const [neighborhood, setNeighborhood] = React.useState('');
      const [favoriteActivities, setFavoriteActivities] = React.useState('');
      const [musicPreferences, setMusicPreferences] = React.useState('');
      const [introvertExtrovert, setIntrovertExtrovert] = React.useState('');
      const [morningNight, setMorningNight] = React.useState('');
      const [dealBreakers, setDealBreakers] = React.useState('');
      const [mustHaves, setMustHaves] = React.useState('');
      const [livingArrangementPrefs, setLivingArrangementPrefs] = React.useState('');
      const [communicationStyle, setCommunicationStyle] = React.useState('');
      const [attachmentStyle, setAttachmentStyle] = React.useState('');
      const [intent, setIntent] = React.useState('');
      const [relationshipIntent, setRelationshipIntent] = React.useState('');
      const [bio, setBio] = React.useState('');
      const [lookingFor, setLookingFor] = React.useState('');
      const [idealFirstDate, setIdealFirstDate] = React.useState('');
      const [favoriteQuote, setFavoriteQuote] = React.useState('');
      const [funFact, setFunFact] = React.useState('');
      const [conversationStarters, setConversationStarters] = React.useState('');
      const [mainProfilePic, setMainProfilePic] = React.useState(null);
      const [standardPics, setStandardPics] = React.useState([]);
      const [privatePics, setPrivatePics] = React.useState([]);
      const [uploading, setUploading] = React.useState(false);
      const [error, setError] = React.useState(null);
      const [success, setSuccess] = React.useState(false);
      const [passwordMatch, setPasswordMatch] = React.useState(null);
      const [locationInfo, setLocationInfo] = React.useState('');
      const [isUpdate, setIsUpdate] = React.useState(false);
      const [loading, setLoading] = React.useState(true);

      React.useEffect(() => {
        if (!window.firebase?.auth || !window.firebase?.db) {
          setError('Authentication or database service not available. Some features may be limited.');
          setLoading(false);
          return;
        }

        const unsubscribe = window.firebase.onAuthStateChanged(window.firebase.auth, async (currentUser) => {
          if (currentUser) {
            try {
              const userDoc = await window.firebase.getDoc(
                window.firebase.doc(window.firebase.db, 'users', currentUser.uid)
              );
              if (userDoc.exists()) {
                const userData = userDoc.data();
                setIsUpdate(true);
                setFirstName(userData.basicInfo.firstName || '');
                setLastName(userData.basicInfo.lastName || '');
                setUsername(userData.basicInfo.username || '');
                setEmail(userData.basicInfo.email || '');
                setRawPhoneNumber(userData.basicInfo.phoneNumber || '');
                setPhoneNumber(formatPhoneNumber(userData.basicInfo.phoneNumber || ''));
                setDateOfBirth(userData.basicInfo.dateOfBirth || '');
                setGenderIdentity(userData.basicInfo.genderIdentity || '');
                setSexualOrientation(userData.basicInfo.sexualOrientation || '');
                setRelationshipStatus(userData.basicInfo.relationshipStatus || '');
                setInterestedIn(userData.basicInfo.interestedIn || '');
                setHeight(userData.physicalAttributes.height?.toString() || '');
                setBodyType(userData.physicalAttributes.bodyType || '');
                setHairColor(userData.physicalAttributes.hairColor || '');
                setEyeColor(userData.physicalAttributes.eyeColor || '');
                setEthnicity(userData.physicalAttributes.ethnicity || '');
                setDistinguishingFeatures(userData.physicalAttributes.distinguishingFeatures || '');
                setDrinkingHabits(userData.lifestyleHabits.drinkingHabits || '');
                setSmokingHabits(userData.lifestyleHabits.smokingHabits || '');
                setFourTwentyFriendly(userData.lifestyleHabits.fourTwentyFriendly || '');
                setOtherSubstanceUse(userData.lifestyleHabits.otherSubstanceUse || '');
                setOccupation(userData.lifestyleHabits.occupation || '');
                setLanguagesSpoken(userData.lifestyleHabits.languagesSpoken || '');
                setPets(userData.lifestyleHabits.pets || '');
                setChildren(userData.lifestyleHabits.children || '');
                setZipCode(userData.locationLogistics.zipCode || '');
                setCurrentCity(userData.locationLogistics.currentCity || '');
                setNeighborhood(userData.locationLogistics.neighborhood || '');
                setFavoriteActivities(userData.interestsLifestyle.favoriteActivities || '');
                setMusicPreferences(userData.interestsLifestyle.musicPreferences || '');
                setIntrovertExtrovert(userData.interestsLifestyle.introvertExtrovert || '');
                setMorningNight(userData.interestsLifestyle.morningNight || '');
                setDealBreakers(userData.relationshipPreferences.dealBreakers || '');
                setMustHaves(userData.relationshipPreferences.mustHaves || '');
                setLivingArrangementPrefs(userData.relationshipPreferences.livingArrangementPrefs || '');
                setCommunicationStyle(userData.relationshipPreferences.communicationStyle || '');
                setAttachmentStyle(userData.relationshipPreferences.attachmentStyle || '');
                setIntent(userData.relationshipPreferences.intent || '');
                setRelationshipIntent(userData.relationshipPreferences.relationshipIntent || '');
                setBio(userData.writtenSections.bio || '');
                setLookingFor(userData.writtenSections.lookingFor || '');
                setIdealFirstDate(userData.writtenSections.idealFirstDate || '');
                setFavoriteQuote(userData.writtenSections.favoriteQuote || '');
                setFunFact(userData.writtenSections.funFact || '');
                setConversationStarters(userData.writtenSections.conversationStarters || '');
                if (userData.images.mainProfilePic) {
                  setMainProfilePic({
                    preview: userData.images.mainProfilePic.url,
                    url: userData.images.mainProfilePic.url,
                    public_id: userData.images.mainProfilePic.public_id,
                    active: userData.images.mainProfilePic.active,
                  });
                }
                setStandardPics(
                  (userData.images.standardPics || []).map((pic, index) => ({
                    preview: pic.url,
                    url: pic.url,
                    public_id: pic.public_id,
                    active: pic.active,
                    id: `${pic.public_id}-${index}`,
                  }))
                );
                setPrivatePics(
                  (userData.images.privatePics || []).map((pic, index) => ({
                    preview: pic.url,
                    url: pic.url,
                    public_id: pic.public_id,
                    active: pic.active,
                    id: `${pic.public_id}-${index}`,
                  }))
                );
              } else {
                console.warn('User document not found for UID:', currentUser.uid);
              }
            } catch (error) {
              console.error('Error fetching user data:', error);
              setError('Failed to load user data.');
            }
          }
          setLoading(false);
        });

        return () => unsubscribe && unsubscribe();
      }, []);

      React.useEffect(() => {
        if (password && confirmPassword) {
          setPasswordMatch(password === confirmPassword);
        } else {
          setPasswordMatch(null);
        }
      }, [password, confirmPassword]);

      const generateUniqueId = (file) => {
        return `${file.name}-${file.size}-${file.lastModified}`;
      };

      const handleFileChange = (e, type) => {
        const files = Array.from(e.target.files);
        if (files.length === 0) return;

        const maxSize = 5 * 1024 * 1024;
        for (const file of files) {
          if (file.size > maxSize) {
            setError(`File "${file.name}" exceeds 5MB limit.`);
            return;
          }
        }

        if (type === 'main') {
          const file = files[0];
          const reader = new FileReader();
          reader.onload = () => {
            setMainProfilePic({ file, preview: reader.result });
          };
          reader.readAsDataURL(file);
        } else if (type === 'standard') {
          const newFiles = files.slice(0, 12 - standardPics.length);
          Promise.all(
            newFiles.map(file => {
              return new Promise(resolve => {
                const reader = new FileReader();
                reader.onload = () => {
                  resolve({ file, preview: reader.result, active: true, id: generateUniqueId(file) });
                };
                reader.readAsDataURL(file);
              });
            })
          ).then(newPics => {
            setStandardPics(prev => [...prev, ...newPics].slice(0, 12));
          });
        } else if (type === 'private') {
          Promise.all(
            files.map(file => {
              return new Promise(resolve => {
                const reader = new FileReader();
                reader.onload = () => {
                  resolve({ file, preview: reader.result, active: true, id: generateUniqueId(file) });
                };
                reader.readAsDataURL(file);
              });
            })
          ).then(newPics => {
            setPrivatePics(prev => [...prev, ...newPics]);
          });
        }
        e.target.value = '';
      };

      const handleDeleteMainPic = () => {
        if (standardPics.length > 0) {
          const newMainPic = standardPics.find(pic => pic.active);
          if (newMainPic) {
            setMainProfilePic(newMainPic);
            setStandardPics(standardPics.filter(pic => pic.id !== newMainPic.id));
          } else {
            setMainProfilePic(null);
          }
        } else {
          setMainProfilePic(null);
        }
      };

      const handleMarkInactive = (id, type) => {
        if (type === 'standard') {
          setStandardPics(standardPics.map(pic =>
            pic.id === id ? { ...pic, active: false } : pic
          ));
        } else if (type === 'private') {
          setPrivatePics(privatePics.map(pic =>
            pic.id === id ? { ...pic, active: false } : pic
          ));
        }
      };

      const uploadImageToCloudinary = async (file) => {
        if (!CLOUDINARY_CLOUD_NAME || !CLOUDINARY_UPLOAD_PRESET) {
          throw new Error('Cloudinary configuration is missing.');
        }

        const formData = new FormData();
        formData.append('file', file);
        formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
        formData.append('folder', 'user_profiles');

        try {
          const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`, {
            method: 'POST',
            body: formData,
          });
          const data = await response.json();
          if (data.error) {
            throw new Error(data.error.message);
          }
          return { public_id: data.public_id, url: data.secure_url };
        } catch (error) {
          console.error('Cloudinary upload error:', error);
          throw error;
        }
      };

      const formatPhoneNumber = (value) => {
        const digits = value.replace(/\D/g, '');
        if (digits.length <= 3) return digits;
        if (digits.length <= 6) return `(${digits.slice(0, 3)}) ${digits.slice(3)}`;
        return `(${digits.slice(0, 3)}) ${digits.slice(3, 6)}-${digits.slice(6, 10)}`;
      };

      const handlePhoneNumberChange = (e) => {
        const digits = e.target.value.replace(/\D/g, '');
        setRawPhoneNumber(digits);
        setPhoneNumber(formatPhoneNumber(digits));
      };

      const handleZipCodeBlur = () => {
        if (!zipCode) {
          setLocationInfo('');
          return;
        }

        const isCanadian = /^[A-Za-z]\d[A-Za-z][ -]?\d[A-Za-z]\d$/i.test(zipCode);
        if (isCanadian) {
          setLocationInfo('');
          return;
        }

        if (/^\d{5}$/.test(zipCode)) {
          fetch(`http://api.zippopotam.us/us/${zipCode}`)
            .then(response => response.json())
            .then(data => {
              if (data.places && data.places[0]) {
                const { 'place name': city, 'state abbreviation': state } = data.places[0];
                setCurrentCity(city);
                setLocationInfo(`${city}, ${state}`);
              } else {
                setLocationInfo('Invalid ZIP code');
              }
            })
            .catch(() => setLocationInfo('Error fetching location'));
        } else {
          setLocationInfo('Invalid ZIP code format');
        }
      };

      const handleSubmit = async (e) => {
        e.preventDefault();
        if (!window.firebase?.auth || !window.firebase?.db) {
          setError('Authentication or database service not available.');
          return;
        }
        if (!email || !username || !zipCode || !mainProfilePic) {
          setError('Please fill in all required fields (Email, Username, ZIP/Postal Code, Main Profile Picture).');
          return;
        }
        if (!isUpdate && (!password || !confirmPassword)) {
          setError('Please provide and confirm your password.');
          return;
        }
        if (!isUpdate && password !== confirmPassword) {
          setError('Passwords do not match.');
          return;
        }

        try {
          setUploading(true);
          setError(null);

          let mainProfilePicData = mainProfilePic.url ? { public_id: mainProfilePic.public_id, url: mainProfilePic.url } : null;
          if (mainProfilePic?.file) {
            mainProfilePicData = await uploadImageToCloudinary(mainProfilePic.file);
          }

          const standardPicsData = await Promise.all(
            standardPics.map(async pic => {
              if (pic.url && !pic.file) {
                return { public_id: pic.public_id, url: pic.url, active: pic.active };
              }
              const { public_id, url } = await uploadImageToCloudinary(pic.file);
              return { public_id, url, active: pic.active };
            })
          );

          const privatePicsData = await Promise.all(
            privatePics.map(async pic => {
              if (pic.url && !pic.file) {
                return { public_id: pic.public_id, url: pic.url, active: pic.active };
              }
              const { public_id, url } = await uploadImageToCloudinary(pic.file);
              return { public_id, url, active: pic.active };
            })
          );

          const timeoutPromise = (promise, time) => {
            return Promise.race([
              promise,
              new Promise((_, reject) => setTimeout(() => reject(new Error('Operation timed out')), time))
            ]);
          };

          let user = window.firebase.auth.currentUser;
          if (!isUpdate) {
            const userCredential = await timeoutPromise(
              window.firebase.createUserWithEmailAndPassword(window.firebase.auth, email, password),
              10000
            );
            user = userCredential.user;
            await window.firebase.setDoc(
              window.firebase.doc(window.firebase.db, 'users', user.uid),
              { loginStatus: 'logged_in', createdAt: window.firebase.serverTimestamp() },
              { merge: true }
            );
          } else if (password && password === confirmPassword) {
            await timeoutPromise(
              window.firebase.updatePassword(user, password),
              10000
            );
          }

          const userData = {
            basicInfo: {
              firstName,
              lastName,
              username,
              email,
              phoneNumber: rawPhoneNumber,
              dateOfBirth,
              genderIdentity,
              sexualOrientation,
              relationshipStatus,
              interestedIn
            },
            physicalAttributes: {
              height: parseInt(height) || 0,
              bodyType,
              hairColor,
              eyeColor,
              ethnicity,
              distinguishingFeatures
            },
            lifestyleHabits: {
              drinkingHabits,
              smokingHabits,
              fourTwentyFriendly,
              otherSubstanceUse,
              occupation,
              languagesSpoken,
              pets,
              children
            },
            locationLogistics: {
              zipCode,
              currentCity,
              neighborhood
            },
            interestsLifestyle: {
              favoriteActivities,
              musicPreferences,
              introvertExtrovert,
              morningNight
            },
            relationshipPreferences: {
              dealBreakers,
              mustHaves,
              livingArrangementPrefs,
              communicationStyle,
              attachmentStyle,
              intent,
              relationshipIntent
            },
            writtenSections: {
              bio,
              lookingFor,
              idealFirstDate,
              favoriteQuote,
              funFact,
              conversationStarters
            },
            images: {
              mainProfilePic: mainProfilePicData ? { public_id: mainProfilePicData.public_id, url: mainProfilePicData.url, active: true } : null,
              standardPics: standardPicsData,
              privatePics: privatePicsData
            },
            loginStatus: user ? 'logged_in' : 'logged_out',
            updatedAt: window.firebase.serverTimestamp(),
            ...(isUpdate ? {} : { createdAt: window.firebase.serverTimestamp() })
          };

          await timeoutPromise(
            window.firebase.setDoc(
              window.firebase.doc(window.firebase.db, 'users', user.uid),
              userData,
              { merge: true }
            ),
            10000
          );

          console.log(isUpdate ? 'User updated:' : 'User signed up:', user.uid, userData);
          setSuccess(true);
          setTimeout(() => {
            window.location.href = '/index.html';
          }, 2000);
        } catch (error) {
          console.error('Submit error:', error.message, error.code, error.stack);
          setError(`Error: ${error.message}`);
          setSuccess(false);
        } finally {
          setUploading(false);
        }
      };

      return (
        <div className="bg-white rounded-lg shadow-md p-6 mb-6">
          <h2 className="text-2xl font-semibold text-primary mb-4">{isUpdate ? 'Update Profile' : 'Sign Up'}</h2>
          {loading && <div className="text-center">Loading profile...</div>}
          {success && (
            <div className="bg-green-100 text-green-700 p-4 rounded-lg mb-4">
              {isUpdate ? 'Profile updated successfully! Redirecting...' : 'Account created successfully! Redirecting...'}
            </div>
          )}
          {error && (
            <div className="bg-red-100 text-red-700 p-4 rounded-lg mb-4">
              {error}
            </div>
          )}
          {!loading && (
            <form onSubmit={handleSubmit} className="signup-form-grid space-y-6">
              <div className="col-span-full">
                <h3 className="text-xl font-semibold text-dark section-divider">Images</h3>
                <div className="image-section mb-4">
                  <div className="mr-4">
                    <label className="form-label">Main Profile Picture *</label>
                    <input
                      type="file"
                      accept="image/jpeg,image/png"
                      onChange={(e) => handleFileChange(e, 'main')}
                      className="form-input mb-2"
                      disabled={uploading}
                    />
                    {mainProfilePic && (
                      <div>
                        <img
                          src={mainProfilePic.preview}
                          alt="Main Profile Picture"
                          className="main-profile-pic"
                        />
                        <button
                          type="button"
                          onClick={handleDeleteMainPic}
                          className="bg-red-500 text-white py-1 px-2 rounded-lg hover:bg-red-600 mt-2"
                          disabled={uploading}
                        >
                          Delete
                        </button>
                      </div>
                    )}
                  </div>
                  <div className="standard-pic-container">
                    <label className="form-label">{`Standard Pictures (up to ${12 - standardPics.length} more)`}</label>
                    <input
                      type="file"
                      accept="image/jpeg,image/png"
                      multiple
                      onChange={(e) => handleFileChange(e, 'standard')}
                      className="form-input mb-2"
                      disabled={standardPics.length >= 12 || uploading}
                    />
                    <div className="pic-grid">
                      {standardPics.filter(pic => pic.active).map(pic => (
                        <div key={pic.id}>
                          <img
                            src={pic.preview}
                            alt="Standard Picture"
                            className="standard-pic"
                          />
                          <div className="image-actions">
                            <button
                              type="button"
                              onClick={() => handleMarkInactive(pic.id, 'standard')}
                              className="bg-gray-500 text-white py-1 px-2 rounded-lg hover:bg-gray-600"
                              disabled={uploading}
                            >
                              Mark Inactive
                            </button>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                  <div className="private-pic-container mt-4">
                    <label className="form-label">Private Pictures</label>
                    <input
                      type="file"
                      accept="image/jpeg,image/png"
                      multiple
                      onChange={(e) => handleFileChange(e, 'private')}
                      className="form-input mb-2"
                      disabled={uploading}
                    />
                    <div className="pic-grid">
                      {privatePics.filter(pic => pic.active).map(pic => (
                        <div key={pic.id}>
                          <img
                            src={pic.preview}
                            alt="Private Picture"
                            className="private-pic"
                          />
                          <div className="image-actions">
                            <button
                              type="button"
                              onClick={() => handleMarkInactive(pic.id, 'private')}
                              className="bg-gray-500 text-white py-1 px-2 rounded-lg hover:bg-gray-600"
                              disabled={uploading}
                            >
                              Mark Inactive
                            </button>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                </div>
              </div>
              <div className="col-span-full">
                <h3 className="text-xl font-semibold text-dark section-divider">Basic Information - * All fields in this section are required</h3>
                <div className="signup-form-grid">
                  <div className="form-group">
                    <label className="form-label">First Name *</label>
                    <input
                      type="text"
                      placeholder="Enter first name"
                      value={firstName}
                      onChange={(e) => setFirstName(e.target.value)}
                      className="form-input"
                      required
                    />
                  </div>
                  <div className="form-group">
                    <label className="form-label">Last Name *</label>
                    <input
                      type="text"
                      placeholder="Enter last name"
                      value={lastName}
                      onChange={(e) => setLastName(e.target.value)}
                      className="form-input"
                      required
                    />
                  </div>
                  <div className="form-group">
                    <label className="form-label">Username *</label>
                    <input
                      type="text"
                      placeholder="Enter username"
                      value={username}
                      onChange={(e) => setUsername(e.target.value)}
                      className="form-input"
                      required
                    />
                  </div>
                  <div className="form-group">
                    <label className="form-label">Email *</label>
                    <input
                      type="email"
                      placeholder="Enter your email"
                      value={email}
                      onChange={(e) => setEmail(e.target.value)}
                      className="form-input"
                      required
                      disabled={isUpdate}
                    />
                  </div>
                  {!isUpdate && (
                    <>
                      <div className="form-group">
                        <label className="form-label">Password *</label>
                        <input
                          type="password"
                          placeholder="Enter password"
                          value={password}
                          onChange={(e) => setPassword(e.target.value)}
                          className={`form-input ${passwordMatch === true ? 'password-match' : passwordMatch === false ? 'password-mismatch' : ''}`}
                          required
                        />
                      </div>
                      <div className="form-group">
                        <label className="form-label">Confirm Password *</label>
                        <input
                          type="password"
                          placeholder="Confirm password"
                          value={confirmPassword}
                          onChange={(e) => setConfirmPassword(e.target.value)}
                          className={`form-input ${passwordMatch === true ? 'password-match' : passwordMatch === false ? 'password-mismatch' : ''}`}
                          required
                        />
                        {passwordMatch === false && (
                          <span className="text-red-600 text-xs">Passwords do not match</span>
                        )}
                        {passwordMatch === true && (
                          <span className="text-green-600 text-xs">Passwords match</span>
                        )}
                      </div>
                    </>
                  )}
                  {isUpdate && (
                    <>
                      <div className="form-group">
                        <label className="form-label">New Password (Optional)</label>
                        <input
                          type="password"
                          placeholder="Enter new password"
                          value={password}
                          onChange={(e) => setPassword(e.target.value)}
                          className={`form-input ${passwordMatch === true ? 'password-match' : passwordMatch === false ? 'password-mismatch' : ''}`}
                        />
                      </div>
                      <div className="form-group">
                        <label className="form-label">Confirm New Password (Optional)</label>
                        <input
                          type="password"
                          placeholder="Confirm new password"
                          value={confirmPassword}
                          onChange={(e) => setConfirmPassword(e.target.value)}
                          className={`form-input ${passwordMatch === true ? 'password-match' : passwordMatch === false ? 'password-mismatch' : ''}`}
                        />
                        {passwordMatch === false && (
                          <span className="text-red-600 text-xs">Passwords do not match</span>
                        )}
                        {passwordMatch === true && (
                          <span className="text-green-600 text-xs">Passwords match</span>
                        )}
                      </div>
                    </>
                  )}
                  <div className="form-group">
                    <label className="form-label">What Are You Here For? *</label>
                    <select
                      value={intent}
                      onChange={(e) => setIntent(e.target.value)}
                      className="form-input"
                      required
                    >
                      <option value="">Select Your Intent</option>
                      <option value="Fun Chat">Fun Chat</option>
                      <option value="Just Friends 😉">'Just Friends' 😉</option>
                      <option value="One Night Stand">One Night Stand</option>
                      <option value="Long Term Hookup">Long Term Hookup</option>
                      <option value="Short Term Hookup">Short Term Hookup</option>
                      <option value="Casual Dating">Casual Dating</option>
                      <option value="Romance">Romance</option>
                      <option value="Marriage">Marriage</option>
                    </select>
                  </div>
                  
                  <div className="form-group">
                    <label className="form-label">Date of Birth *</label>
                    <input
                      type="date"
                      value={dateOfBirth}
                      onChange={(e) => setDateOfBirth(e.target.value)}
                      className="form-input"
                      required
                    />
                  </div>
                  <div className="form-group">
                    <label className="form-label">Gender Identity *</label>
                    <select
                      value={genderIdentity}
                      onChange={(e) => setGenderIdentity(e.target.value)}
                      className="form-input"
                      required
                    >
                      <option value="">Select Gender Identity</option>
                      <option value="Male">Male</option>
                      <option value="Female">Female</option>
                      <option value="Non-Binary">Non-Binary</option>
                      <option value="Transgender">Transgender</option>
                      <option value="Other">Other</option>
                    </select>
                  </div>
                  <div className="form-group">
                    <label className="form-label">Sexual Orientation *</label>
                    <select
                      value={sexualOrientation}
                      onChange={(e) => setSexualOrientation(e.target.value)}
                      className="form-input"
                      required
                    >
                      <option value="">Select Sexual Orientation</option>
                      <option value="Straight">Straight</option>
                      <option value="Gay">Gay</option>
                      <option value="Lesbian">Lesbian</option>
                      <option value="Bisexual">Bisexual</option>
                      <option value="Pansexual">Pansexual</option>
                      <option value="Other">Other</option>
                    </select>
                  </div>
                  <div className="form-group">
                    <label className="form-label">Relationship Status *</label>
                    <select
                      value={relationshipStatus}
                      onChange={(e) => setRelationshipStatus(e.target.value)}
                      className="form-input"
                      required
                    >
                      <option value="">Select Relationship Status</option>
                      <option value="Single">Single</option>
                      <option value="Divorced">Divorced</option>
                      <option value="Separated">Separated</option>
                      <option value="Widowed">Widowed</option>
                      <option value="Married">Married</option>
                      <option value="Living Together">Living Together</option>
                      <option value="Open Marriage">Open Marriage</option>
                    </select>
                  </div>
                  <div className="form-group">
                    <label className="form-label">Interested In *</label>
                    <select
                      value={interestedIn}
                      onChange={(e) => setInterestedIn(e.target.value)}
                      className="form-input"
                      required
                    >
                      <option value="">Select Interested In </option>
                      <option value="Men">Men</option>
                      <option value="Women">Women</option>
                      <option value="Everyone">Everyone</option>
                      <option value="Non-Binary">Non-Binary</option>
                    </select>
                  </div>
                </div>
              </div>
              <div className="form-group">
                    <label className="form-label">Height *</label>
                    <select
                      value={height}
                      onChange={(e) => setHeight(e.target.value)}
                      className="form-input"
                      required
                    >
                      <option value="">Select Height</option>
                      {[...Array(55).keys()].map(i => {
                        const inches = 40 + i;
                        const feet = Math.floor(inches / 12);
                        const remainingInches = inches % 12;
                        return (
                          <option key={inches} value={inches}>
                            {`${feet}'${remainingInches}"`}
                          </option>
                        );
                      })}
                    </select>
                  </div>
                  <br /><hr /><hr /><br />
              <div className="form-group">
                    <label className="form-label">Phone Number - **only used for future text msg enhancement**</label>
                    <input
                      type="tel"
                      placeholder="(xxx) xxx-xxxx"
                      value={phoneNumber}
                      onChange={handlePhoneNumberChange}
                      className="form-input"
                      maxLength={14}
                    />
                  </div>
              <div className="col-span-full">
                <h3 className="text-xl font-semibold text-dark section-divider">Physical Attributes</h3>
                <div className="signup-form-grid">
                  
                  <div className="form-group">
                    <label className="form-label">Body Type</label>
                    <select
                      value={bodyType}
                      onChange={(e) => setBodyType(e.target.value)}
                      className="form-input"
                    >
                      <option value="">Select Body Type</option>
                      <option value="Athletic">Athletic</option>
                      <option value="Fit">Fit</option>
                      <option value="Skinny">Skinny</option>
                      <option value="Fat">Fat</option>
                      <option value="Chunky">Chunky</option>
                      <option value="Fluffy">Fluffy</option>
                      <option value="Round">Round</option>
                      <option value="Stick Figure">Stick Figure</option>
                      <option value="Perfect">Perfect</option>
                      <option value="Almost Perfect">Almost Perfect</option>
                    </select>
                  </div>
                  <div className="form-group">
                    <label className="form-label">Hair Color</label>
                    <select
                      value={hairColor}
                      onChange={(e) => setHairColor(e.target.value)}
                      className="form-input"
                    >
                      <option value="">Select Hair Color</option>
                      <option value="Black">Black</option>
                      <option value="Brown">Brown</option>
                      <option value="Blonde">Blonde</option>
                      <option value="Red">Red</option>
                      <option value="Gray">Gray</option>
                      <option value="Other">Other</option>
                    </select>
                  </div>
                  <div className="form-group">
                    <label className="form-label">Eye Color</label>
                    <select
                      value={eyeColor}
                      onChange={(e) => setEyeColor(e.target.value)}
                      className="form-input"
                    >
                      <option value="">Select Eye Color</option>
                      <option value="Blue">Blue</option>
                      <option value="Brown">Brown</option>
                      <option value="Green">Green</option>
                      <option value="Hazel">Hazel</option>
                      <option value="Other">Other</option>
                    </select>
                  </div>
                  <div className="form-group">
                    <label className="form-label">Ethnicity/Race</label>
                    <select
                      value={ethnicity}
                      onChange={(e) => setEthnicity(e.target.value)}
                      className="form-input"
                    >
                      <option value="">Select Ethnicity</option>
                      <option value="Asian">Asian</option>
                      <option value="Black">Black</option>
                      <option value="Hispanic">Hispanic</option>
                      <option value="White">White</option>
                      <option value="Other">Other</option>
                    </select>
                  </div>
                  <div className="form-group">
                    <label className="form-label">Distinguishing Features</label>
                    <input
                      type="text"
                      placeholder="e.g., Tattoos, Piercings"
                      value={distinguishingFeatures}
                      onChange={(e) => setDistinguishingFeatures(e.target.value)}
                      className="form-input"
                    />
                  </div>
                </div>
              </div>
              <div className="col-span-full">
                <h3 className="text-xl font-semibold text-dark section-divider">Lifestyle & Habits</h3>
                <div className="signup-form-grid">
                  <div className="form-group">
                    <label className="form-label">Drinking Habits</label>
                    <select
                      value={drinkingHabits}
                      onChange={(e) => setDrinkingHabits(e.target.value)}
                      className="form-input"
                    >
                      <option value="">Select Drinking Habits</option>
                      <option value="Never">Never</option>
                      <option value="Socially">Socially</option>
                      <option value="Regularly">Regularly</option>
                      <option value="Nightly">Nightly</option>
                      <option value="It's 5 o'clock somewhere">It's 5 o'clock somewhere</option>
                    </select>
                  </div>
                  <div className="form-group">
                    <label className="form-label">Smoking Habits</label>
                    <select
                      value={smokingHabits}
                      onChange={(e) => setSmokingHabits(e.target.value)}
                      className="form-input"
                    >
                      <option value="">Select Smoking Habits</option>
                      <option value="Non-Smoker">Non-Smoker</option>
                      <option value="Social Smoker">Social Smoker</option>
                      <option value="Regular Smoker">Regular Smoker</option>
                    </select>
                  </div>
                  <div className="form-group">
                    <label className="form-label">420 Friendly?</label>
                    <select
                      value={fourTwentyFriendly}
                      onChange={(e) => setFourTwentyFriendly(e.target.value)}
                      className="form-input"
                    >
                      <option value="">Select Option</option>
                      <option value="Yes">Yes</option>
                      <option value="No">No</option>
                    </select>
                  </div>
                  <div className="form-group">
                    <label className="form-label">Other Substance Use</label>
                    <input
                      type="text"
                      placeholder="e.g., None, Occasional"
                      value={otherSubstanceUse}
                      onChange={(e) => setOtherSubstanceUse(e.target.value)}
                      className="form-input"
                    />
                  </div>
                  <div className="form-group">
                    <label className="form-label">Occupation/Profession</label>
                    <input
                      type="text"
                      placeholder="Enter occupation"
                      value={occupation}
                      onChange={(e) => setOccupation(e.target.value)}
                      className="form-input"
                    />
                  </div>
                  <div className="form-group">
                    <label className="form-label">Languages Spoken</label>
                    <input
                      type="text"
                      placeholder="e.g., English, Spanish"
                      value={languagesSpoken}
                      onChange={(e) => setLanguagesSpoken(e.target.value)}
                      className="form-input"
                    />
                  </div>
                  <div className="form-group">
                    <label className="form-label">Pets/Pet Preferences</label>
                    <input
                      type="text"
                      placeholder="e.g., Dogs, No pets"
                      value={pets}
                      onChange={(e) => setPets(e.target.value)}
                      className="form-input"
                    />
                  </div>
                  <div className="form-group">
                    <label className="form-label">Children</label>
                    <select
                      value={children}
                      onChange={(e) => setChildren(e.target.value)}
                      className="form-input"
                    >
                      <option value="">Select Option</option>
                      <option value="Have Children">Have Children</option>
                      <option value="Don't Have Children">Don't Have Children</option>
                      <option value="Want Children">Want Children</option>
                      <option value="Don't Want Children">Don't Want Children</option>
                    </select>
                  </div>
                </div>
              </div>
              <div className="col-span-full">
                <h3 className="text-xl font-semibold text-dark section-divider">Location & Logistics</h3>
                <div className="signup-form-grid">
                  <div className="form-group">
                    <label className="form-label">ZIP/Postal Code (US or Canada) *</label>
                    <input
                      type="text"
                      placeholder="e.g., 10001 or K1A 0B1"
                      value={zipCode}
                      onChange={(e) => setZipCode(e.target.value)}
                      onBlur={handleZipCodeBlur}
                      className="form-input"
                      maxLength={7}
                      required
                    />
                    {locationInfo && (
                      <span className="text-xs text-gray-600">{locationInfo}</span>
                    )}
                  </div>
                  <div className="form-group">
                    <label className="form-label">Current City/Town</label>
                    <input
                      type="text"
                      placeholder="Enter city/town"
                      value={currentCity}
                      onChange={(e) => setCurrentCity(e.target.value)}
                      className="form-input"
                    />
                  </div>
                  <div className="form-group">
                    <label className="form-label">Neighborhood</label>
                    <input
                      type="text"
                      placeholder="Enter neighborhood"
                      value={neighborhood}
                      onChange={(e) => setNeighborhood(e.target.value)}
                      className="form-input"
                    />
                  </div>
                </div>
              </div>
              <div className="col-span-full">
                <h3 className="text-xl font-semibold text-dark section-divider">Interests & Lifestyle</h3>
                <div className="signup-form-grid">
                  <div className="form-group">
                    <label className="form-label">Favorite Activities</label>
                    <input
                      type="text"
                      placeholder="e.g., Hiking, Reading"
                      value={favoriteActivities}
                      onChange={(e) => setFavoriteActivities(e.target.value)}
                      className="form-input"
                    />
                  </div>
                  <div className="form-group">
                    <label className="form-label">Music Preferences</label>
                    <input
                      type="text"
                      placeholder="e.g., Rock, Jazz"
                      value={musicPreferences}
                      onChange={(e) => setMusicPreferences(e.target.value)}
                      className="form-input"
                    />
                  </div>
                  <div className="form-group">
                    <label className="form-label">Introvert/Extrovert</label>
                    <select
                      value={introvertExtrovert}
                      onChange={(e) => setIntrovertExtrovert(e.target.value)}
                      className="form-input"
                    >
                      <option value="">Select Option</option>
                      <option value="Introvert">Introvert</option>
                      <option value="Extrovert">Extrovert</option>
                      <option value="Ambivert">Ambivert</option>
                    </select>
                  </div>
                  <div className="form-group">
                    <label className="form-label">Morning Person/Night Owl</label>
                    <select
                      value={morningNight}
                      onChange={(e) => setMorningNight(e.target.value)}
                      className="form-input"
                    >
                      <option value="">Select Option</option>
                      <option value="Morning Person">Morning Person</option>
                      <option value="Night Owl">Night Owl</option>
                    </select>
                  </div>
                </div>
              </div>
              <div className="col-span-full">
                <h3 className="text-xl font-semibold text-dark section-divider">Relationship Preferences</h3>
                <div className="signup-form-grid">
                                    
                  <div className="form-group">
                    <label className="form-label">Deal-Breakers</label>
                    <input
                      type="text"
                      placeholder="e.g., Smoking, Dishonesty"
                      value={dealBreakers}
                      onChange={(e) => setDealBreakers(e.target.value)}
                      className="form-input"
                    />
                  </div>
                  <div className="form-group">
                    <label className="form-label">Must-Haves in a Partner</label>
                    <input
                      type="text"
                      placeholder="e.g., Kindness, Humor"
                      value={mustHaves}
                      onChange={(e) => setMustHaves(e.target.value)}
                      className="form-input"
                    />
                  </div>
                  <div className="form-group">
                    <label className="form-label">Living Arrangement Preferences</label>
                    <input
                      type="text"
                      placeholder="e.g., Living alone, Roommates"
                      value={livingArrangementPrefs}
                      onChange={(e) => setLivingArrangementPrefs(e.target.value)}
                      className="form-input"
                    />
                  </div>
                  <div className="form-group">
                    <label className="form-label">Communication Style</label>
                    <select
                      value={communicationStyle}
                      onChange={(e) => setCommunicationStyle(e.target.value)}
                      className="form-input"
                    >
                      <option value="">Select Communication Style</option>
                      <option value="Direct">Direct</option>
                      <option value="Passive">Passive</option>
                      <option value="Open">Open</option>
                      <option value="Other">Other</option>
                    </select>
                  </div>
                  <div className="form-group">
                    <label className="form-label">Attachment Style (Optional)</label>
                    <select
                      value={attachmentStyle}
                      onChange={(e) => setAttachmentStyle(e.target.value)}
                      className="form-input"
                    >
                      <option value="">Select Attachment Style</option>
                      <option value="Secure">Secure</option>
                      <option value="Anxious">Anxious</option>
                      <option value="Avoidant">Avoidant</option>
                      <option value="Disorganized">Disorganized</option>
                    </select>
                  </div>
                </div>
              </div>
              <div className="col-span-full">
                <h3 className="text-xl font-semibold text-dark section-divider">Written Sections</h3>
                <div className="space-y-4">
                  <div className="form-group">
                    <label className="form-label">About Me/Bio</label>
                    <textarea
                      placeholder="Tell us about yourself"
                      value={bio}
                      onChange={(e) => setBio(e.target.value)}
                      className="form-input min-h-[100px]"
                    />
                  </div>
                  <div className="form-group">
                    <label className="form-label">What I’m Looking For</label>
                    <textarea
                      placeholder="Describe your ideal partner"
                      value={lookingFor}
                      onChange={(e) => setLookingFor(e.target.value)}
                      className="form-input min-h-[100px]"
                    />
                  </div>
                  <div className="form-group">
                    <label className="form-label">Ideal First Date</label>
                    <textarea
                      placeholder="Describe your perfect first date"
                      value={idealFirstDate}
                      onChange={(e) => setIdealFirstDate(e.target.value)}
                      className="form-input min-h-[100px]"
                    />
                  </div>
                  <div className="form-group">
                    <label className="form-label">Favorite Quote/Motto</label>
                    <input
                      type="text"
                      placeholder="Enter your favorite quote"
                      value={favoriteQuote}
                      onChange={(e) => setFavoriteQuote(e.target.value)}
                      className="form-input"
                    />
                  </div>
                  <div className="form-group">
                    <label className="form-label">Fun Fact About Yourself</label>
                    <input
                      type="text"
                      placeholder="Share a fun fact"
                      value={funFact}
                      onChange={(e) => setFunFact(e.target.value)}
                      className="form-input"
                    />
                  </div>
                  <div className="form-group">
                    <label className="form-label">Conversation Starters</label>
                    <textarea
                      placeholder="e.g., Favorite movie, Hobby"
                      value={conversationStarters}
                      onChange={(e) => setConversationStarters(e.target.value)}
                      className="form-input min-h-[100px]"
                    />
                  </div>
                </div>
              </div>
              <div className="form-group col-span-full">
                <button
                  type="submit"
                  className={`bg-primary text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition w-full ${uploading ? 'uploading' : ''}`}
                  disabled={passwordMatch === false || uploading}
                >
                  {uploading ? 'Processing...' : isUpdate ? 'Update Profile' : 'Sign Up'}
                </button>
              </div>
            </form>
          )}
        </div>
      );
    }

    function App() {
      const [user, setUser] = React.useState(null);
      const [initError, setInitError] = React.useState(null);
      const [loading, setLoading] = React.useState(true);

      React.useEffect(() => {
        let unsubscribe = null;
        const waitForFirebase = async () => {
          try {
            // Wait for Firebase to initialize
            let attempts = 0;
            while (!window.firebaseInitialized && attempts < 50) {
              await new Promise(resolve => setTimeout(resolve, 100));
              attempts++;
            }
            if (!window.firebaseInitialized) {
              throw new Error('Firebase failed to initialize within timeout');
            }
            if (window.firebaseError) {
              throw window.firebaseError;
            }
            if (!window.firebase || !window.firebase.auth || !window.firebase.db) {
              throw new Error('Firebase services not properly initialized');
            }

            // Set auth persistence
            try {
              await window.firebase.setPersistence(window.firebase.auth, window.firebase.browserSessionPersistence);
              console.log('Auth persistence set to browserSessionPersistence');
            } catch (persistenceError) {
              console.warn('Failed to set auth persistence:', persistenceError.message);
              // Continue despite persistence failure, as it's not critical
            }

            // Set up auth state listener
            unsubscribe = window.firebase.onAuthStateChanged(
              window.firebase.auth,
              async (currentUser) => {
                try {
                  if (currentUser) {
                    const userDoc = await window.firebase.getDoc(
                      window.firebase.doc(window.firebase.db, 'users', currentUser.uid)
                    );
                    if (userDoc.exists()) {
                      const userData = userDoc.data();
                      const profile = await fetchUserProfile(currentUser.uid);
                      setUser({
                        ...currentUser,
                        profile,
                        loginStatus: 'logged_in'
                      });
                      console.log('App: User authenticated:', { uid: currentUser.uid, username: profile.username });
                    } else {
                      setUser({ ...currentUser, loginStatus: 'logged_in' });
                      console.log('App: User authenticated, no profile:', { uid: currentUser.uid });
                    }
                  } else {
                    setUser(null);
                    console.log('App: No user authenticated');
                  }
                } catch (userError) {
                  console.error('Error processing auth state:', userError);
                  setInitError(`Failed to process user data: ${userError.message}`);
                  setUser(null);
                } finally {
                  setLoading(false);
                }
              },
              (authError) => {
                console.error('Auth state listener error:', authError);
                setInitError(`Authentication error: ${authError.message}`);
                setLoading(false);
              }
            );
          } catch (error) {
            console.error('App initialization error:', {
              message: error.message,
              code: error.code,
              stack: error.stack
            });
            setInitError(`Failed to initialize app: ${error.message}. Some features may be limited.`);
            setUser(null);
            setLoading(false);
          }
        };

        waitForFirebase();

        return () => {
          if (unsubscribe) {
            console.log('Cleaning up auth state listener');
            unsubscribe();
          }
        };
      }, []);      

      return (
        <ErrorBoundary>
          <div className="min-h-screen flex flex-col">
            {initError && (
              <div className="error">
                <h2>Initialization Error</h2>
                <p>{initError}</p>
              </div>
            )}
            {loading ? (
              <div className="flex items-center justify-center min-h-screen">
                <p>Loading...</p>
              </div>
            ) : (
              <>
                <Header user={user} setUser={setUser} />
                <main className="container flex-grow px-2 sm:px-4 py-6">
                  <SignupForm />
                </main>
                <Footer />
              </>
            )}
          </div>
        </ErrorBoundary>
      );
    }

    // Render the App
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>